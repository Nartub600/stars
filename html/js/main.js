var canvas,stage,exportRoot,promises;var tween=createjs.Tween;var ease=createjs.Ease;var isFirefox,isIOS,isAndroid,isMac,isChrome,isSafari,isIPad,isMobile,isiPhone;isFirefox=navigator.userAgent.toLowerCase().indexOf("firefox")!=-1;isChrome=navigator.userAgent.toLowerCase().indexOf("chrome")!=-1;isiPhone=navigator.userAgent.toLowerCase().indexOf("iphone")!=-1||navigator.userAgent.toLowerCase().indexOf("ipod")!=-1;isIOS=navigator.userAgent.toLowerCase().indexOf("iphone")!=-1||navigator.userAgent.toLowerCase().indexOf("ipad")!=-1||navigator.userAgent.toLowerCase().indexOf("ipod")!=-1;isAndroid=navigator.userAgent.toLowerCase().indexOf("android")!=-1;isMac=navigator.userAgent.toLowerCase().indexOf("macintosh")!=-1;isSafari=navigator.userAgent.toLowerCase().indexOf("safari")!=-1;isIPad=navigator.userAgent.toLowerCase().indexOf("ipad")!=-1;isMobile=isIOS||isAndroid||isIPad;var urls;function init(){if(isLocal()){urls={newest:"json/promises.json",shared:"json/most-shared.json",official:"json/official.json",flag:""}}else{urls={newest:$("#json_newest").val(),shared:$("#json_shared").val(),official:$("#json_official").val(),flag:$("#url_flag").val()}}promises={};loadJSON(urls.newest,"newest",function(){loadJSON(urls.shared,"shared",function(){loadJSON(urls.official,"official",createjs_init)})})}function createjs_init(){canvas=document.getElementById("canvas");images=images||{};var a=new createjs.LoadQueue(false);a.addEventListener("fileload",handleFileLoad);a.addEventListener("complete",handleComplete);a.loadManifest(lib.properties.manifest)}function handleFileLoad(a){if(a.item.type=="image"){images[a.item.id]=a.result}}function handleComplete(){if(isset("initSite")){initSite()}exportRoot=new lib.assets();exportRoot.on("tick",update);stage=new createjs.Stage(canvas);stage.addChild(exportRoot);stage.enableMouseOver();createjs.Ticker.setFPS(lib.properties.fps);createjs.Ticker.addEventListener("tick",stage);createjs.Touch.enable(stage);exportRoot.scrollbar.alpha=0;exportRoot.bg.alpha=0;createjs.Tween.get(exportRoot.bg).to({alpha:1},1000);createjs.Tween.get(exportRoot.scrollbar).wait(2000).call(function(){renderStars("newest");checkPromise()}).wait(1000).to({alpha:1},500);exportRoot.scrollbar.center.on("mousedown",function(b){var a=b._get_localX();setPercent(a/exportRoot.scrollbar.center.getBounds().width)},exportRoot.scrollbar.center);exportRoot.phase2.visible=false;exportRoot.phase2copy.visible=false;$("#canvas").on("mousewheel",function(b){if(isPhase2){return}var c=b.deltaY/500;c*=3;var a=exportRoot.scrollbar.percent+c;setPercent(a);b.preventDefault();return false});stage.update()}function checkPromise(){var b=$.getUrlVar("promise");if(b&&b!=""){var a=$("#url_promise").val()+"/"+b;$.get(a,function(f){if(!f.id){f=JSON.parse(f)}if(f.id){var e=$("#fb_user").val();var d=$("#tw_user").val();var c=$("#tb_user").val();if(f.user.id==e||f.user.id==d||f.user.id==c){mypromise(f)}else{mypromise(f,true)}}})}}var isSwiping;var pointA;var pointB;function handleswipe(a){var b;switch(a.type){case"mousedown":pointA={x:a.stageX,y:a.stageY};break;case"pressmove":pointB={x:a.stageX,y:a.stageY};b=distance(pointA,pointB);if(!isSwiping){if(b>10){isSwiping=true;pointB=pointA}}else{b=(pointA.x-pointB.x)/exportRoot.scaleX;exportRoot.scrollbar.drag.x+=b;pointB=pointA}break;case"pressup":isSwiping=false;break}}function setPercent(a){if(a>1){a=1}if(a<0){a=0}exportRoot.scrollbar.percent=a;exportRoot.scrollbar.drag.setPercent(exportRoot.scrollbar.percent);exportRoot.scrollbar.dispatchEvent(new createjs.Event("change"));exportRoot.scrollbar.closePopup()}function update(){resize();if(textOwner){updateTextPosition()}}var lastsize={w:0,h:0};function resize(){var c=$("#wrapper");var m=c.width();var i=c.height();if(lastsize.w==m&&lastsize.h==i){return}lastsize.w=m;lastsize.h=i;canvas.style.width=m+"px";canvas.style.height=i+"px";exportRoot.scaleX=2000/m;exportRoot.scaleY=1087/i;var d=$(".header-mobile").height();var n=d!=null&&d>0;var o=isiPhone||n?10:186;var p=isiPhone||n?84:239;exportRoot.scrollbar.x=o;exportRoot.scrollbar.y=i-60;exportRoot.scrollbar.setSize(m-o-p);if(isPhase2){var f=exportRoot.bg;f.y=-750}var a=exportRoot.shine;a.x=m-1614>>1;a.y=i-347;exportRoot.phase2.x=m>>1;exportRoot.phase2copy.x=m>>1;var l=1;var g=1;var j=exportRoot.phase2;var b=exportRoot.phase2copy;if(n){l=0.5;g=0.68}j.scaleX=l;j.scaleY=l;b.scaleX=g;b.scaleY=g;if(isPhase2){tween.removeTweens(j);tween.removeTweens(b);var k=lastsize.h-350*l;var e=k>>1;j.y=lastsize.h;b.y=e}exportRoot.dispatchEvent(new createjs.Event("resize"))}var layer1widthscale=2;var layer2widthscale=1.5;var layer3widthscale=1.3;var layer1starscale=1;var layer2starscale=0.5;var layer3starscale=0.3;var stars;var currentSetRendered;function getUsers(a){return promises.official.concat(promises[a])}var totalWidth;var totalPaddingLeft;function renderStars(b){if(currentSetRendered==b){return}if(isRunningShow){stopShowInterval()}hideText();var l=getUsers(b);currentSetRendered=b;var d=Math.round(l.length*0.2);var m=Math.round(l.length*0.3);var g=exportRoot.layer1;var f=exportRoot.layer2;var e=exportRoot.layer3;var p=33+5+20;var a=15;g.removeAllChildren();f.removeAllChildren();e.removeAllChildren();var n=exportRoot.scrollbar.y-p-a;var c;var k=0;var q={left:20,right:50};stars=[];totalPaddingLeft=q.left;totalWidth=(exportRoot.bg.getBounds().width)*layer1widthscale;for(var j=0;j<l.length;j++){k+=200/48;var o=new lib.StarScene();o.scaleX=o.scaleY=0;if(j<d){g.addChild(o);o.layer=g;o.layerScale=layer1widthscale;c=layer1starscale;o.x=(exportRoot.bg.getBounds().width-q.left-q.right)*Math.random()*layer1widthscale+q.left}else{if(j<d+m){f.addChild(o);o.layer=f;o.layerScale=layer2widthscale;c=layer2starscale;o.x=(exportRoot.bg.getBounds().width-q.left-q.right)*Math.random()*layer2widthscale+q.left}else{e.addChild(o);o.layer=e;o.layerScale=layer3widthscale;c=layer3starscale;o.x=(exportRoot.bg.getBounds().width-q.left-q.right)*Math.random()*layer3widthscale+q.left}}o.clicked=false;o.ypercent=Math.random();o.y=o.ypercent*n+p;o.data=l[j];if(!o.data.user.profile_picture||o.data.user.profile_picture==""){o.data.user.profile_picture="http://graph.facebook.com/10203380448764285/picture"}o.targetscale=c;o.image=new Image();o.image.owner=o;o.image.onload=function(){var h=this.owner;createjs.Tween.get(h).to({scaleX:h.targetscale,scaleY:h.targetscale},2000,createjs.Ease.elasticOut);stars.push(h);if(!isRunningShow){startShowInterval()}};o.image.src=o.data.user.profile_picture;o.resizelistener=exportRoot.on("resize",function(){this.y=this.ypercent*exportRoot.scrollbar.y},o)}}function mypromise(b,e){console.log("mypromise",b);var a=new lib.StarScene();console.log(exportRoot);var d=exportRoot.layer1;var c={x:lastsize.w*0.8,y:lastsize.h*0.3};c=d.globalToLocal(c.x,c.y);d.addChild(a);a.layer=d;a.layerScale=layer1widthscale;a.x=c.x;a.y=c.y;a.clicked=false;a.data=b;if(e){a.isEdit=false}else{a.isEdit=true}if(!a.data.user.profile_picture||a.data.user.profile_picture==""){a.data.user.profile_picture="http://graph.facebook.com/10203380448764285/picture"}a.targetscale=layer1starscale;a.image=new Image();a.image.owner=a;a.image.onload=function(){var f=this.owner;console.log("owner",f);stars.push(f);tween.get({}).wait(250).call(function(){console.log(this.click);this.click()},[],f)};a.image.src=a.data.user.profile_picture;a.resizelistener=exportRoot.on("resize",function(){this.y=0.3*exportRoot.scrollbar.y},a)}function setMouseListeners(a){}var currentOpen;function centerCurrent(){var e=currentOpen.localToGlobal(0,0);var a=e.x/exportRoot.scaleX;var f=lastsize.w/2-100;var d=f-a;var g=((exportRoot.bg.getBounds().width-lastsize.w))*layer1widthscale;var c=g/100;var b=((d/c)/100);console.log("current",a,"target",f,"dif",d,"ppp",c,"t",b);setPercent(exportRoot.scrollbar.percent-=b)}function switchLayers(a,c){var b=a.parent.localToGlobal(a.x,a.y);b=c.globalToLocal(b.x,b.y);c.addChild(a);a.x=b.x}function starClickHandler(a){this.over();tween.get({}).wait(100).call(function(){this.click()},[],this)}function starMouseHandler(a){switch(a.type){case"mouseover":this.over();break;case"mouseout":this.out();break}}function closeCurrentOpen(){currentOpen.starBlink.starOpen.gotoAndPlay("p1")}var textOwner=null;function updateTextPosition(){var a=textOwner.localToGlobal(41,-33);$("#msg-promise-container").css({top:a.y/exportRoot.scaleY,left:a.x/exportRoot.scaleX})}function showText(e,c,b){textOwner=b;var a=b.localToGlobal(41,-33);var d;if(e.toLowerCase().indexOf("i promise to ")==0){e=e.slice("I promise to ".length);d='<span class="msg-blue">I promise to </span><span class="msg-black">'+e+'</span> <span class="msg-hash">#TFIOSLittleInfinity</span> <span class="msg-signature">- '+c+"</span> "}else{d='<span class="msg-black">'+e+'</span> <span class="msg-hash">#TFIOSLittleInfinity</span> <span class="msg-signature">- '+c+"</span> "}$("#msg-promise-container").html(d).css({top:a.y/exportRoot.scaleY,left:a.x/exportRoot.scaleX}).fadeIn(80)}function hideText(){$("#msg-promise-container").fadeOut(20);textOwner=null}var showInterval;var isRunningShow;function startShowInterval(){showInterval=setInterval(handleShowInterval,500);isRunningShow=true}function stopShowInterval(){clearInterval(showInterval);isRunningShow=false}var starsActive;var starsLimit=5;function handleShowInterval(){starsActive=starsActive||0;if(stars.length>0&&starsActive<starsLimit){var a=Math.floor(Math.random()*stars.length);var b=stars[a];b.mouseover();b.timer()}}function showStarBlink(b){var d=stars.splice(b,1)[0];var c=new createjs.Bitmap(d.image);var a=getStarBlink();c.mouseEnabled=false;a.star.container.removeAllChildren();a.star.container.addChild(c);a.owner=d;var e=66/c.getBounds().width;c.scaleX=e;c.scaleY=e;c.x=(c.getBounds().width*e)/-2;c.y=(c.getBounds().height*e)/-2;a.star.uncache();d.starBlink=a;d.addChild(a);starsActive++;return d}var poolStarBlink;function getStarBlink(){poolStarBlink=poolStarBlink||[];if(poolStarBlink.length==0){var b=new lib.StarBlink();b.done=function(){poolStarBlink.push(this);stars.push(this.owner);starsActive--;this.parent.removeChild(this)};poolStarBlink.push(b)}var a=poolStarBlink.pop();a.starOpen.gotoAndStop(0);return a}var isPhase2=false;function scrolldown(){if(isPhase2){return}isPhase2=true;var k=ease.quadInOut;var h=exportRoot.layer1;var g=exportRoot.layer2;var d=exportRoot.layer3;var j=1000;tween.get(h,{override:true}).to({y:-lastsize.h},j,k);tween.get(g,{override:true}).to({y:-lastsize.h},j*1.2,k);tween.get(d,{override:true}).to({y:-lastsize.h},j*1.4,k);var i=exportRoot.bg;var f=-750;tween.get(i,{override:true}).to({y:f},j*1.6,k);var l=exportRoot.phase2;var b=exportRoot.phase2copy;l.visible=true;l.y=lastsize.h+l.getBounds().height;tween.get(l,{override:true}).wait(10).to({y:lastsize.h},j*1.6,k);b.visible=true;var p=1;var a=$(".header-mobile").height();var n=a!=null&&a>0;if(n){p=0.5}var m=lastsize.h-350*p;var c=m>>1;b.y=l.y+l.getBounds().height/2;tween.get(b,{override:true}).wait(10).to({y:c},j*1.6,k);var o=exportRoot.scrollbar;tween.get(o,{override:true}).to({alpha:0},j*0.5);$(".content-shorts").fadeOut(250)}function scrollup(){if(!isPhase2){return}isPhase2=false;var d=exportRoot.layer1;var c=exportRoot.layer2;var b=exportRoot.layer3;var g=1000;var h=ease.quadInOut;tween.get(d,{override:true}).wait(g*0.4).to({y:0},g,h);tween.get(c,{override:true}).wait(g*0.2).to({y:0},g*1.2,h);tween.get(b,{override:true}).wait(g*0).to({y:0},g*1.4,h);var f=exportRoot.bg;tween.get(f,{override:true}).to({y:0},g*1.4,h);var i=exportRoot.phase2;var a=exportRoot.phase2copy;tween.get(i,{override:true}).to({y:lastsize.h+i.getBounds().height},g,h).call(function(){i.visible=false});tween.get(a,{override:true}).to({y:lastsize.h+i.getBounds().height/2},g*0.8,h).call(function(){a.visible=false});var j=exportRoot.scrollbar;tween.get(j,{override:true}).wait(g*2).to({alpha:1},g*0.5);$(".content-shorts").fadeIn(250);if(isset("hideHelpYourState")){hideHelpYourState()}}function isset(strVariableName){try{eval(strVariableName)}catch(err){if(err instanceof ReferenceError){return false}}return true}function loadJSON(a,b,c){$.get(a,function(d){if(d instanceof Array==false){d=JSON.parse(d)}promises[b]=d;c()})}function isLocal(){return window.location.href.indexOf("localhost")!=-1}function distance(d,b){var a=0;var c=0;a=b.x-d.x;a=a*a;c=b.y-d.y;c=c*c;return Math.sqrt(a+c)}$.extend({getUrlVars:function(){var d=[],c;var a=window.location.href.slice(window.location.href.indexOf("?")+1).split("&");for(var b=0;b<a.length;b++){c=a[b].split("=");d.push(c[0]);d[c[0]]=c[1]}return d},getUrlVar:function(a){return $.getUrlVars()[a]}});